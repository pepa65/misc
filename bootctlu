#!/bin/bash

# bootctlu - Installing systemd_boot on Ubuntu with kernels in /boot
#
# Required: efivar util-linux(blkid) grep find systemd(bootctl)
#           coreutils(readlink sort cut head tail mkdir cat cp) sudo

edition='generic'
machine_id='ubuntu'

Help(){
	cat <<-EOH
		bootctlu - Installing systemd_boot on Ubuntu with kernels in /boot
		The installation requires root privileges.
		
		Usage:  bootctlu [-n|--nogo] [-q|--quiet] [-i|--install]
		          -n/--nogo:     No writing to the system at all.
		          -i/--install:  Also do the actual installation with bootctl.
		          -q/--quiet:    Only fatal errors output to the terminal.
	EOH
}

Echo(){ # $1: message, $2: errorcode (exit if present)
	if [[ $2 ]]
	then
		echo -e "\nABORT: $1"
		exit $2
	fi
	((quiet)) || echo -e "\n$1"
}

go=1 quiet=0 install=0
while (($#))
do
	case $1 in
	-n|--nogo) go=0 ;;
	-q|--quiet) quiet=1 ;;
	-i|--install) install=1 ;;
	-h|--help) Help && exit 0 ;;
	*) Help && Echo "Unrecognized commandline option '$1'" 1
	esac
	shift
done

# Check UEFI mode, efivars. ESP present & mounted, determine path
! [[ -d /sys/module/efivars ]] &&
	Echo 'Not in UEFI mode' 2
! efivar=$(type -p efivar) &&
	Echo "Package 'efivar' not installed" 3
! "$efivar" -l &>/dev/null &&
	Echo "EFI variables not accessible through '$efivar'" 4
! p=$(blkid |grep 'EFI System') &&
	Echo 'EFI System Partition not mounted' 5
p=${p:0: -1} p=${p##*\"} p=$(readlink -e /dev/disk/by-partuuid/$p)
esp="$(grep "$p" /proc/mounts |cut -d' ' -f2)"
path="$esp/$machine_id"
entries="$esp/loader/entries"

versions=$(find /boot -maxdepth 1 -name "vmlinuz-*-$edition" |grep -Po "\d\.\d+\.\d+\-\d+" |sort -Vr)
d=$(lsb_release -d)
release=${d##*$'\t'}
cmdline=$(cut -d' ' -f2- /proc/cmdline)
if ((go))
then
	! sudo mkdir -p "$path" "$entries" &&
		Echo "Problem making required directories" 6
fi

latest=1 out="$entries/ubuntu.conf"
for version in $versions
do
	entry="$version-$edition"
	((latest)) && latest=0 add="(latest: $entry)" ||
		add="($entry)" out="$entries/ubuntu-$entry.conf"
	file="title $release $add\nversion $entry\nmachine-id $machine_id\noptions $cmdline intel_iommu=on\nlinux /$machine_id/$entry/vmlinuz\ninitrd /$machine_id/$entry/initrd.img"
	Echo "Copying $entry to $path"
	Echo "Writing '$out':"
	if ((go))
	then
		! sudo mkdir -p "$path/$entry" &&
			Echo "Problem making required directory" 7
		sudo cp "/boot/vmlinuz-$entry" "$path/$entry/vmlinuz"
		sudo cp "/boot/initrd.img-$entry" "$path/$entry/initrd.img"
		echo
		echo -e "$file" |sudo tee "$out"
	else
		Echo "$file"
	fi
done

out="$esp/loader/loader.conf"
if [[ -f "$out" ]]
then
	Echo "Notice: '$out' already present:\n"
	((quiet)) || cat "$out"
else
	file="default ubuntu\ntimeout 30s\neditor yes"
	Echo "Writing '$out':"
	((go)) && echo && echo -e "$file" |sudo tee "$out" || Echo "$file"
fi

if ((go))
then
	if ((install))
	then
		Echo "Running 'bootctl install' on $esp"
		sudo bootctl --path=$esp install && Echo "Installation successful"
	else
		Echo "(Not actually installing, no -i/--install option given)"
	fi
else
	Echo "(Not actually installing, -n/--nogo option given)"
fi

exit 0
