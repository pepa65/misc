#!/bin/bash

# bootctlu - Installing systemd_boot on Ubuntu with kernels in /boot
#
# Required: util-linux(blkid) grep find systemd(bootctl)
#           coreutils(readlink sort cut head tail mkdir cat cp)
#           sudo (unless run as root, or only invoked with -n/--nogo)

edition='generic'

Help(){
	cat <<-EOH
		bootctlu - Installing systemd_boot on Ubuntu with kernels in /boot.
		Setup kernel, initrd and entries on ESP, optionally install systemd_boot.
		
		Usage:  bootctlu [-n|--nogo] [-q|--quiet] [-i|--install]
		          -n/--nogo:     No writing to the system at all.
		          -i/--install:  Also do the actual installation with bootctl.
		          -q/--quiet:    Only fatal errors output to the terminal.
	EOH
}

Echo(){ # $1: message, $2: errorcode (exit if present!)
	if [[ $2 ]]
	then
		echo -e "\nABORT: $1"
		exit $2
	fi
	((quiet)) || echo -e "\n$1"
}

go=1 quiet=0 install=0
while (($#))
do
	case $1 in
	-n|--nogo) go=0 ;;
	-q|--quiet) quiet=1 ;;
	-i|--install) install=1 ;;
	-h|--help) Help && exit 0 ;;
	*) Help && Echo "Unrecognized commandline option '$1'" 1
	esac
	shift
done

sudo=
((go && EUID)) && ! sudo=$(type -p sudo) &&
	Echo "Need to escalate privilege, but sudo not present" 2
((go)) || Echo "### Simulation, no actual copying/writing/installing"

[[ -d /sys/firmware/efi/efivars ]] ||
	Echo "Not in UEFI mode, EFI variables not accessible" 3
p=$(blkid |grep 'EFI System') || Echo 'EFI System Partition not mounted' 4

p=${p:0: -1} p=${p##*\"} p=$(readlink -e /dev/disk/by-partuuid/$p)
esp="$(grep "$p" /proc/mounts |cut -d' ' -f2)"
entries="$esp/loader/entries"
id=$(</etc/machine-id)

versions=$(find /boot -maxdepth 1 -name "vmlinuz-*-$edition" |grep -Po "\d\.\d+\.\d+\-\d+" |sort -Vr)
d=$(lsb_release -d)
release=${d##*$'\t'}
cmdline=$(cut -d' ' -f2- /proc/cmdline)
if ((go))
then
	"$sudo" mkdir -p "$esp/$id" "$entries" ||
		Echo "Problem making required directories" 5
fi

for version in $versions
do
	entry="$version-$edition"
	path="$esp/$id/$entry"
	out="$entries/$id-$entry.conf"
	((go)) && ! "$sudo" mkdir -p "$path" &&
		Echo "Problem making required directory" 6
	Echo "Copying files to $path"
	((go)) && "$sudo" cp "/boot/vmlinuz-$entry" "$path/vmlinuz"
	((go)) && "$sudo" cp "/boot/initrd.img-$entry" "$path/initrd.img"
	Echo "Writing '$out':"
	file="title $release ($entry)\nversion $entry\nmachine-id $id\noptions $cmdline intel_iommu=on\nlinux /$id/$entry/vmlinuz\ninitrd /$id/$entry/initrd.img"
	((go)) && echo && echo -e "$file" |"$sudo" tee "$out" || Echo "$file"
done

out="$esp/loader/loader.conf"
[[ -f "$out" ]] &&
	mv "$out" "$out~" &&
	Echo "WARNING: previous loader.conf renamed to '$out~'"

Echo "Writing '$out':"
file="default $id-*\ntimeout 30s\neditor yes"
((go)) && echo && echo -e "$file" |"$sudo" tee "$out" || Echo "$file"

((!go || install)) && Echo "Running 'bootctl install' on $esp"
((go && install)) && "$sudo" bootctl --path="$esp" install &&
	Echo "Installation successful"
((go && !install)) &&
	Echo "Not actually installing, no -i/--install option given"

((go)) ||
	Echo "### End of simulation, nothing actually copied/written/installed"

exit 0
