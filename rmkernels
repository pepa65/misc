#!/bin/bash

## Remove old kernels from Debian/Ubuntu
## Usage: rmkernels

a="$(ls -1 /boot/vmlinuz-* |sed 's@^/boot/vmlinuz-@@' |sort -nr)" ## all
c=$(uname -r) ## currently running kernel version
r="$(grep -v "$c" <<<"$a")" ## rest
echo -e "$c (currently running)\n$r"
## superfluous versions (keep only the latest of same major.minor version)
s=$(ao= bo=
while IFS='.' read a b c
do
	[[ $ao = $a && $bo = $b ]] && echo "$a.$b.${c%-*}"
	ao=$a bo=$b
done <<<"$r")
if [[ $s ]]
then
	echo -e "Remove:\n$s\n"
	g=$(sed 's/ /\\|/g' <<<$s)
	p=$(dpkg -l | grep "$g" | cut -d' ' -f3)
	sudo apt purge $p
else
	echo "Nothing to remove"
fi
