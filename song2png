#!/usr/bin/env bash
# song2png - Convert song to png
# song format:
# - First line is the title (will be bolded)
# - Every empty line yields a paragraph
# - Every '['...']' clause will be italicized and grayed
# - Skip lineas starting with a '!'
# Usage:  song2png <songfile>
#  Output will be the .txt extension replaced (if present) or appended by .png
# Required: chromium imagemagick(mogrify) coreutils(mktemp cat ls)

song=$1
[[ ! -f $song ]] &&
	echo "Abort: Input file '$song' not found" &&
	exit 1

htm=$(mktemp --suffix=.htm) png=${song%.txt}.png

Starthtml() { # I:title,htm
	cat <<-EOH >"$htm"
		<!DOCTYPE html>
		<title>$title</title>
		<style>
		body{font-family:"Garuda",serif; font-size:16pt; font-kerning:normal; line-height:20pt;}
		i{font-size:80%; font-style:italic; color:#aaa;}
		@page{size:399mm 1999mm; margin:.4in;}
		</style>
		<p><b>$title</b>
	EOH
	echo -n "<p>" >>"$htm"
}

title=
while read line
do # Process line
	[[ ${line:0:1} = ! ]] &&
		continue

	[[ -z $title ]] &&
		title=$line &&
		Starthtml &&
		continue

	[[ -z $line ]] &&
		echo -n "<p>" >>"$htm" &&
		continue

	line=${line//[/<i>[} line=${line//]/]</i>}
	echo "$line<br>" >>"$htm"
done <"$song"

chromium --headless=new --window-size=1024,4096 --disable-gpu --enable-chrome-browser-cloud-management --force-device-scale-factor=2 --screenshot="$png" "$htm"
rm "$htm"
mogrify -depth 3 -trim +repage -bordercolor white -border 24 -define png:color-type=3 "$png"
